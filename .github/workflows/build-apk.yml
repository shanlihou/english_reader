name: Build APK

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚v1.0.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'  # ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Get version from tag
        id: tag
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build APK (Debug)
        run: |
          # å°†ç‰ˆæœ¬å·è½¬æ¢ä¸ºAndroidæ„å»ºå· (æ•´æ•°æ ¼å¼)
          BUILD_NUMBER=$(echo "${{ steps.tag.outputs.version }}" | tr -d '.')
          flutter build apk --debug \
            --build-number=$BUILD_NUMBER \
            --build-name=${{ steps.tag.outputs.version }}

      - name: Build APK (Release)
        run: |
          # å°†ç‰ˆæœ¬å·è½¬æ¢ä¸ºAndroidæ„å»ºå· (æ•´æ•°æ ¼å¼)
          BUILD_NUMBER=$(echo "${{ steps.tag.outputs.version }}" | tr -d '.')
          flutter build apk --release \
            --build-number=$BUILD_NUMBER \
            --build-name=${{ steps.tag.outputs.version }}

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-v${{ steps.tag.outputs.version }}
          path: build/app/outputs/flutter-apk/app-debug.apk

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-v${{ steps.tag.outputs.version }}
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ è‹±è¯­é˜…è¯»å™¨ v${{ steps.tag.outputs.version }}

            ### ğŸ“± ä¸‹è½½é“¾æ¥

            - **è°ƒè¯•ç‰ˆ (Debug APK)**ï¼š[app-debug.apk](./app-debug-v${{ steps.tag.outputs.version }}.zip)
            - **æ­£å¼ç‰ˆ (Release APK)**ï¼š[app-release.apk](./app-release-v${{ steps.tag.outputs.version }}.zip)

            ### âœ¨ åŠŸèƒ½ç‰¹æ€§

            - ğŸ“– æœ¬åœ°æ–‡æœ¬é˜…è¯»
            - ğŸ” å­—ä½“å¤§å°è°ƒæ•´
            - ğŸ‘† æ‰‹åŠ¿ç¿»é¡µ
            - ğŸŒ åœ¨çº¿ç¿»è¯‘
            - ğŸ“š å†å²è®°å½•
            - â­ å•è¯æœ¬
            - ğŸ“Š é˜…è¯»è¿›åº¦
            - ğŸŒ™ æ·±è‰²/æµ…è‰²ä¸»é¢˜

            ### ğŸ’¡ å®‰è£…è¯´æ˜

            1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„APKæ–‡ä»¶
            2. åœ¨è®¾å¤‡ä¸Šå®‰è£…ï¼ˆéœ€è¦å¼€å¯"æœªçŸ¥æ¥æº"æƒé™ï¼‰
            3. å¼€å§‹ä½¿ç”¨è‹±è¯­é˜…è¯»å™¨ï¼

            ---
            ç”± GitHub Actions è‡ªåŠ¨æ„å»º ğŸš€
          files: |
            build/app/outputs/flutter-apk/app-debug.apk
            build/app/outputs/flutter-apk/app-release.apk
          draft: false
          prerelease: false
